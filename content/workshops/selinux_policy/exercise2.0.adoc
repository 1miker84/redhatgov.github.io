---
title: "Exercise 2.0 - Creating Custom SELinux Policy"
workshops: selinux_policy
workshop_weight: 20
layout: lab
---

:license_url: http://ansible-workshop-bos.redhatgov.io/ansible-license.json

:icons: font
:imagesdir: /workshops/selinux_policy/images


= Exercise 2.0 - Creating Custom SELinux Policy

== Exercise Description

In this exercise, we are going to write custom policy for an example application.


=== Step 1: Change directories

Create a `src` directory, in your home directory.

{{< highlight bash >}}
$ cd ~
$ mkdir src
$ cd src
{{< /highlight >}}

=== Step 2: Check out the source code to the example application from GitHub

Download the latest code release

{{< highlight bash >}}
$ git clone https://github.com/ajacocks/selinuxlab.git
$ cd selinuxlab
{{< /highlight >}}

=== Step 3: Deploy the lab application, with Ansible

Now, use Ansible to deploy the test application

{{< highlight bash >}}
$ ansible-playbook setup-testapp.yml
{{< /highlight >}}

=== Step 4: Application and Service Info

Take a look at the application, and the associated service, that you just installed

{{< highlight bash >}}
ls -l /usr/local/sbin/testapp
{{< /highlight >}}
[source,bash]
----
-rwxr-xr-x. 1 root root 48688 Feb 20 18:03 /usr/local/sbin/testapp
----
{{< highlight bash >}}
systemctl status testapp
{{< /highlight >}}
[source,bash]
----
‚óè testapp.service - Testing SELinux app
   Loaded: loaded (/usr/lib/systemd/system/testapp.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
----

=== Step 5: Generate an initial generic SELinux policy

Create a policy directory, and generate an initial policy.  Use `sepolicy generate` to generate a policy for the app that we want to enable.

[source,bash]
----
cd ~/src
mkdir policy
cd policy
sepolicy generate --init /usr/local/sbin/testapp
----

Note the last few lines in the output from `sepolicy generate`:
[source,bash]
----
Created the following files:
/home/ec2-user/src/policy/testapp.te # Type Enforcement file
/home/ec2-user/src/policy/testapp.if # Interface file
/home/ec2-user/src/policy/testapp.fc # File Contexts file
/home/ec2-user/src/policy/testapp_selinux.spec # Spec file
/home/ec2-user/src/policy/testapp.sh # Setup Script
----

You will need all of these files to customize the policy, for the application.

.SELinux Policy Source Compnents
. `testapp.te` is the base policy for the application.  It sets the basic rules of the policy
. `testapp.if` is the *interface* file.  Interfaces are like public functions, in that they provide ways for other SELinux modules to interact with the one that you are writing
. `testapp.fc` is the *file contexts* file.  It contains the labeling information for all filesystem objects that the policy references
. `testapp.sh` is a Red Hat provided script that compiles and loads the SELinux policy module

=== Step 6: Identify variables

Fill a few variables out in an inventory file: `admin_password`, `pg_password`, `rabbitmq_password`

[subs=+quotes]
----

[tower]
localhost ansible_connection=local

[database]

[all:vars]
admin_password=*'ansibleWS'*

pg_host=''
pg_port=''

pg_database='awx'
pg_username='awx'
pg_password=*'ansibleWS'*

rabbitmq_port=5672
rabbitmq_vhost=tower
rabbitmq_username=tower
rabbitmq_password=*'ansibleWS'*
rabbitmq_cookie=cookiemonster

# Needs to be true for fqdns and ip addresses
rabbitmq_use_long_name=false

----

=== Step 7: Run setup

Run the Ansible Tower setup script

[source,bash]
----
sudo ./setup.sh
----

[NOTE]
Step 7 will take approx. 10-15 minutes to complete.  This may be a good time to take a break.


=== Step 8: Confirm results

At this point, your Ansible Tower installation should be complete.
You can access your Tower workshop (not forgetting that *workshopname* is the name of your workshop, and *#* is your student number) at:


[source,bash]
----
{{< urifqdn "" "tower" "" >}}
----

=== Ensuring Installation Success

You know you were successful if you are able to browse to your Ansible Tower's url (_control node's IP address_) and get something like this

image::ansible-lab-figure01-logon-screen.png[caption="Figure 2: ", title="Ansible Tower Login Screen"]

{{< importPartial "footer/footer.html" >}}
